# 智能自动跟随书包 - 设计与实现说明

本文件整理当前固件的设计思路、硬件连接与关键逻辑，内容与代码保持一致。

## 1. 功能概览

- UWB 双基站测距，实现跟随
- 姿态检测（MPU6050）
- 称重检测（HX711）
- 路径示教与回放
- 蓝牙遥控
- WS2812 灯带控制

## 2. 工作模式

| 模式 | 名称 | 功能 |
|---|---|---|
| 0 | 待机 | 显示重量，超 1kg 三声提醒 |
| 1 | 背负 | 姿态异常蜂鸣提示 |
| 2 | 跟随 | UWB 跟随，距离 <= 1m 停止 |
| 3 | 手拉 | 手动推拉 |
| 4 | 归位 | 回放示教路线 |
| 5 | 示教 | 蓝牙遥控记录路径 |

按钮逻辑：
- 单击：待机 → 背负 → 跟随 → 示教 → 手拉 → 待机
- 双击：进入归位模式
- 长按：切换 WS2812 灯带

## 3. 硬件与引脚

| 模块 | 引脚 |
|---|---|
| OLED | GPIO21/22 (I2C0) |
| MPU6050 | GPIO25/26 (I2C1) |
| UWB0 | RX16 / TX17 |
| UWB1 | RX27 / TX13 |
| L298N | IN1=5 IN2=14 IN3=32 IN4=33 |
| HX711 | DOUT=18 / SCK=19 |
| 按钮 | GPIO4 |
| 蜂鸣器 | GPIO23（低电平有效） |
| WS2812 | GPIO12（30 颗） |

L298N 说明：
- ENA/ENB 跳线帽保持接 5V，不接 ESP32
- PWM 调速通过 IN1/IN2/IN3/IN4 实现

## 4. 串口/蓝牙命令

- W/A/S/D/X 或 F/B/L/R/X：前进/后退/左/右/停止
- M：切换模式
- P：进入示教模式
- E：进入归位模式
- T：称重去皮
- C：IMU 校准

## 5. 跟随控制

- 低通滤波 + 转向迟滞
- 距离 <= 1m 停止
- 目标距离默认 80cm

## 6. 路径示教与归位

- 示教模式记录“动作+持续时间”
- 归位模式为回放示教路线

## 7. 电机 PWM 速度

- 跟随速度与示教速度可独立配置
- 通过 `motor.setSpeed()` 在模式切换时设置

## 8. TODO

- PID 跟随控制
- OLED 动画与平滑刷新
- 电量指示
- 紧急停止按钮
